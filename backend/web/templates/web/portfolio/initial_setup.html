{% extends 'web/base.html' %}

{% block title %}Initial Setup{% endblock %}

{% block content %}
<h2>Initial Portfolio Setup</h2>

{% if error %}
<p style="color: red;">{{ error }}</p>
{% endif %}

<form method="post">
    {% csrf_token %}
    {{ cash_balance_form.as_p }}
    <div id="portfolio-entries-container">
        {{ portfolio_entry_formset.management_form }}
        {% for form in portfolio_entry_formset %}
            <div class="portfolio-entry-form">
                {{ form.as_p }}
                <button type="button" class="remove-entry-button" onclick="removePortfolioEntry(this)">Remove</button>
            </div>
        {% endfor %}
    </div>
    <button type="button" id="add-entry-button">Add Entry</button>
    <button type="submit">Submit</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-entry-button').addEventListener('click', addPortfolioEntry);
    });

    function addPortfolioEntry() {
        const container = document.getElementById('portfolio-entries-container');
        const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
        const formCount = parseInt(totalForms.value);

        const newForm = container.firstElementChild.cloneNode(true);
        const formRegex = RegExp(`form-(\\d){1}-`, 'g');

        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formCount}-`);
        newForm.querySelectorAll('input').forEach(input => input.value = '');
        newForm.querySelector('.remove-entry-button').style.display = 'inline-block';

        totalForms.value = formCount + 1;
        container.appendChild(newForm);
    }

    function removePortfolioEntry(button) {
        const entryDiv = button.parentElement;
        const container = document.getElementById('portfolio-entries-container');
        container.removeChild(entryDiv);

        const forms = container.querySelectorAll('.portfolio-entry-form');
        const totalForms = document.querySelector('#id_form-TOTAL_FORMS');

        forms.forEach((form, index) => {
            form.querySelectorAll('input').forEach(input => {
                const name = input.getAttribute('name').replace(/form-\d+-/, `form-${index}-`);
                input.setAttribute('name', name);
                const id = input.getAttribute('id').replace(/id_form-\d+-/, `id_form-${index}-`);
                input.setAttribute('id', id);
            });
        });

        totalForms.value = forms.length;
    }
</script>

{% endblock %}
